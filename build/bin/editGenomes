#!/usr/bin/env python3
import sys
import os.path as osp
from pycbio.tsv import TsvReader
from pycbio.sys import fileOps
import re
from zooCommon import loadZooEquiv, getZooGenArkAcc, GenomeMissingError

def editGenomeLine(zooToGenArk, line):
    key, genome = line.split()
    return "genome " + getZooGenArkAcc(zooToGenArk, genome)

def processLine(zooToGenArk, line):
    if line.startswith("genome "):
        return editGenomeLine(zooToGenArk, line)
    elif line.startswith("twoBitPath"):
        return "# " + line
    else:
        return line

def editGenomes(zooToGenArk, inGenomes, outFh):
    errCnt = 0
    for line in fileOps.iterLines(inGenomes):
        try:
            line = processLine(zooToGenArk, line)
            print(line, file=outFh)
        except GenomeMissingError as ex:
            print("Failed: ", ex, file=sys.stderr)
            errCnt += 1
    if errCnt > 0:
        exit("failed genomes")

def main():
    zooToGenArk = loadZooEquiv()
    with open("genomes.txt", 'w') as outFh:
        editGenomes(zooToGenArk, "asm-hub.genomes.txt", outFh)

main()
